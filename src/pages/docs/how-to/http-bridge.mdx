import { Callout } from 'nextra/components'

# Use the HTTP API Bridge

Our API is built around [UCAN Invocation](https://github.com/ucan-wg/invocation). This
allows clients to verify that our service executed a submitted UCAN invocation and produced a
given result. This gives us a flexible, interoperable, verifiable computational abstraction
to build upon, but is not widely supported by programming languages or operating system utilities, which
is a significant disadvantage compared to a more traditional auth-token-based HTTP API.

To compensate for this, we've implemented a "bridge" that lets you use the tools you
know and love to interact with our API in a manner that should feel familiar if you've
used an HTTP-based API before.

## Limitations

The instructions below are oriented toward capabilities invoked on spaces. These include:

| `access/delegate` |
| `space/info` |
| `space/allocate` |
| `store/add` |
| `store/get` |
| `store/remove` |
| `store/list` |
| `upload/add` |
| `upload/list` |
| `upload/remove` |
| `usage/report` |


Other capabilities are invoked on other entities. They are supported by the bridge, but
you will need to generate auth tokens that are targetted at different DIDs and may not
be well supported by our tools - please let us know if you are interested in this functionality
so we can better support your use cases!

## Authentication and Authorization

Our UCAN Invocation-based API uses public/private keypairs to identify users and UCAN Delegation
to allow those keypairs to invoke specific capabilities. The HTTP Bridge uses the same fundamental primitives
but confines them to two separate HTTP headers, `X-Auth-Secret` and `Authorization`, that can be generated
by clients without interacting with our service.

Details of how to generate the header values can be found in the
[W3UP UCAN Bridge Protocol](https://github.com/web3-storage/specs/blob/main/w3-ucan-bridge.md) specification, but
they can also be generated for you by the [`w3` CLI](https://github.com/web3-storage/w3cli):

### Generating Auth Headers with `w3cli`

If you have not already logged in and created a space with the `w3` CLI, do that first:

```sh
w3 login you@example.com
# follow onscreen instructions
w3 space create
# follow onscreen instructions
```

Next, find the DID of the space you'd like to use with the bridge:

```sh
w3 space ls
* did:key:z6Mkabc123
```

And use the `bridge generate-tokens` command to generate header values:

```sh
w3 bridge generate-tokens did:key:z6Mkabc123 --can 'store/add' --can 'upload/add' --can 'upload/list' --expiration `date -v +24H +%s`
```

The example command above uses the `--expiration` option to specify that these headers will be
valid for 24 hours. It uses the `--can` options to specify that the headers can be used to invoke
`store/add`, `upload/add` or `upload/list` capabilities.

The result of `w3 bridge generate-tokens` will contain the values of the `X-Auth-Secret` and `Authorization` headers:

```txt
X-Auth-Secret header: uOGQyYzRhYWQwNmY3NtEwOTg1ZWU0NDU0NjByNTg2ZGE

Authorization header: uOqJlcm9vdHOB2CpYKQABcRIgYVymlT6sxiDd45CA0f...
```

These can be used with `curl` like:

```sh
curl -X POST \
-H "X-Auth-Secret: uOGQyYzRhYWQwNmY3NtEwOTg1ZWU0NDU0NjByNTg2ZGE" \
-H "Authorization: uOqJlcm9vdHOB2CpYKQABcRIgYVymlT6sxiDd45CA0f..." \
...
https://up.web3.storage/bridge
```

## Listing Uploads

Listing uploads in a space is one of the easiest ways to ensure the bridge is working. We'll
give an example using the common unix utility `curl`:

First, create a file named `list.json` and put the following JSON in it, replacing `did:key:z6Mkabc123`
with the space you used to generate auth headers above:

```json
{
  "tasks": [
    [
      "upload/list",
      "did:key:z6Mkabc123",
      {}
    ]
  ]
}
```

Next, run `curl` as follows, replacing the values of the `X-Auth-Secret` and `Authorization`
headers with the values you generated above:

```sh
curl -X POST \
-H "X-Auth-Secret: uOGQyYzRhYWQwNmY3NtEwOTg1ZWU0NDU0NjByNTg2ZGE" \
-H "Authorization: uOqJlcm9vdHOB2CpYKQABcRIgYVymlT6sxiDd45CA0f..." \
-d @list.json \
https://up.web3.storage/bridge
```

## Storing Files

You can store individual files as [big as 5GB](https://github.com/web3-storage/w3infra/blob/26106e315e79bf8072d2bd052786e46563d9a1da/upload-api/service.js#L12-L16) in
spaces on web3.storage. To store larger files, see the [Sharded Uploads](#sharded-uploads) section below.

To upload a file to your space you'll first need convert it to a CAR. Assuming your file is
named `hello.txt` you can first use `ipfs-car` to create a CAR:

```sh
ipfs-car pack hello.txt > hello.car
bafybeidhkumeonuwkebh2i4fc7o7lguehauradvlk57gzake6ggjsy372a
```

<Callout type="info">
If you already have a file available on the public IPFS network by CID, you can turn it into a CAR that can be uploaded to our service with:

```sh
ipfs dag export bafybeidhkumeonuwkebh2i4fc7o7lguehauradvlk57gzake6ggjsy372a > hello.car
```
</Callout>

Hang on to the `bafy...` Content ID output here! You'll need it for the "Registering Uploads" section below. Next,
calculate the Content ID of the CAR you just created:

```sh
ipfs-car hash hello.car
bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq
```

You'll also need to calculate the size of `hello.car` in bytes. The common utility `wc` works well:

```sh
wc -c hello.car
161 hello.car
```

Next, create a file (in this example we'll name it `store.json`) and put the following JSON
in it, replacing `did:key:z6Mkabc123` with the space you used to generate auth headers above:

```json
{
  "tasks": [
    [
      "store/add",
      "did:key:z6Mkabc123",
      {
        "link": { "/": "bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq" },
        "size": 161
      }
    ]
  ]
}
```

Finally, run `curl` replacing the values of the `X-Auth-Secret` and `Authorization`
headers with the values you generated above:

```sh
curl -X POST \
-H "X-Auth-Secret: uOGQyYzRhYWQwNmY3NtEwOTg1ZWU0NDU0NjByNTg2ZGE" \
-H "Authorization: uOqJlcm9vdHOB2CpYKQABcRIgYVymlT6sxiDd45CA0f..." \
-d @store.json \
https://up.web3.storage/bridge
```

You'll get a response that includes a number of different fields:

```json
[
  {
    "p": {
      "fx": {
        "fork": []
      },
      "iss": "did:web:web3.storage",
      "meta": {},
      "out": {
        "ok": {
          "allocated": 161,
          "headers": {
            "content-length": "161",
            "x-amz-checksum-sha256": "5NswWHZdy73RY/nH3BQAGKfTAXKPO1BYLmJCjEx34PM="
          },
          "link": {
            "/": "bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq"
          },
          "status": "upload",
          "url": "https://carpark-prod-0.s3.us-west-2.amazonaws.com/bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq/bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq.car?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAXLN6VFMM76NYBTG7%2F20240307%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240307T170854Z&X-Amz-Expires=86400&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEMn%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQC2snXc59uBD2ugjc7C9DiKP0447T7fZ0A010Ph6iDswgIgfq0fYWE4Y9FByHz%2B6mYRussCgVr9KlBV1eGd1kgA22Yq3AMIwv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw1MDU1OTUzNzQzNjEiDCjNsn%2FQBypcXnybPCqwAyGtjDvgxmoQg8IYvO4vQ5fxZw%2F69mzSB%2BJmJMl9gnMaQ7SqUuTQnamPEZHM%2BaztPTbSBFm26S9o4GcZWn5S9UCOLb4YV6sAeCC3XCMkc58RPvyehMiVf0xdN1lBCLkFDd%2BHDb0cPEOvvJbTor22rhCo9L%2FsAVZPAYBu1efwvifCMnUebFeA3Qc0lvYG9PqLtZwo2ZMeVCwXYZiwec%2FpwdobopEWve88GJtxrVyiWMuV4pO7A68cty5ukFr0aRwNHM9g2e2y%2BSymH8pS6mfWpdope%2F%2BB6JoYvKKPN%2FQMpvROl0BxNdTD%2FgNUNqKjlNfUDtV7NqaDJlTqtlTXp44%2F7AUk7yJgK9UlVmp7B30oNH3fPtNXEFBbowoVczqcDBfp%2BxDBMZRFDa37VNcoIdjEBpBTCZk5hONDpjlp%2FyGd1EPSswbQyr6nA5xwLunfF6HhWA%2B8ZMp5raiepAPm%2FS7QfpbiZGtEZ%2FoVWENmPI4HLjDKYjXRJ7i680K9cMDeFSHjHvaTYsgOh09jmL5OnKSMRbANl4bNihk%2FX7pWgxVmbV0Qj%2BQ5eDpvsYUe9i%2FTUVAyODDU5KevBjqeATdV%2Fp9WiSN1mc1%2FUxn60TYZRFAjcTm6lfdbdtEEWneexsLLj6BpoW6gUA1c73JjEXsOEGbaSfHXi%2BI6nFtlNJpKlP%2BbrFlylA2qmIvlnKJzv2ALrsARUmCH1Kl26CVFfOtnJv7VZmDSVnS9nr4mYLHLkPjIhBaF3IxWVcFR7He0CCfRv%2BYkHzTlVdzoK%2BmJkUVyofY%2B3Bt3dDkpk7No&X-Amz-Signature=1d4cbc65a8440c89eb2770b2edfe4e3fe91831856ee03d0d939911d9963337f0&X-Amz-SignedHeaders=content-length%3Bhost%3Bx-amz-checksum-sha256&x-id=PutObject",
          "with": "did:key:z6Mkm5qHN9g9NQSGbBfL7iGp9sexdssioT4CzyVap9ATqGqX"
        }
      },
      "prf": [],
      "ran": {
        "/": "bafyreib732osv25yuv4zs7fhr6ijywa4itb62g6o7chej2jh6ierf6o6jy"
      }
    },
    "s": {
      "/": {
        "bytes": "7aEDQH53KYLjnCneSTc9nslSC1AjFCU1dtGOgwwaCopfxS1Stur+GzYpubUnvjykRbqcyUvaHutl+XVxoZuOwV2mRgY"
      }
    }
  }
]
```

The three you care about are `p.out.ok.status`, `p.out.ok.url` and `p.out.ok.headers`. If the value of `p.out.ok.status` is `done`,
congratulations! You're done. The file has already been uploaded to our system and you don't need to do anything else.

If the value of `p.out.ok.status` is `upload` you'll need to send an HTTP `PUT` to the value of `p.out.ok.url`, passing the bytes of the CAR
in the body of the request and including the HTTP headers in `p.out.ok.headers`:

```sh
curl -v -X PUT \
-H "content-length: 161" \
-H "x-amz-checksum-sha256: 5NswWHZdy73RY/nH3BQAGKfTAXKPO1BYLmJCjEx34PM=" \
--data-binary @hello.car \
https://carpark-prod-0.s3.us-west-2.amazonaws.com/bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq/bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq.car\?X-Amz-Algorithm\=AWS4-HMAC-SHA256\&X-Amz-Content-Sha256\=UNSIGNED-PAYLOAD\&X-Amz-Credential\=ASIAXLN6VFMM76NYBTG7%2F20240307%2Fus-west-2%2Fs3%2Faws4_request\&X-Amz-Date\=20240307T170854Z\&X-Amz-Expires\=86400\&X-Amz-Security-Token\=IQoJb3JpZ2luX2VjEMn%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQC2snXc59uBD2ugjc7C9DiKP0447T7fZ0A010Ph6iDswgIgfq0fYWE4Y9FByHz%2B6mYRussCgVr9KlBV1eGd1kgA22Yq3AMIwv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw1MDU1OTUzNzQzNjEiDCjNsn%2FQBypcXnybPCqwAyGtjDvgxmoQg8IYvO4vQ5fxZw%2F69mzSB%2BJmJMl9gnMaQ7SqUuTQnamPEZHM%2BaztPTbSBFm26S9o4GcZWn5S9UCOLb4YV6sAeCC3XCMkc58RPvyehMiVf0xdN1lBCLkFDd%2BHDb0cPEOvvJbTor22rhCo9L%2FsAVZPAYBu1efwvifCMnUebFeA3Qc0lvYG9PqLtZwo2ZMeVCwXYZiwec%2FpwdobopEWve88GJtxrVyiWMuV4pO7A68cty5ukFr0aRwNHM9g2e2y%2BSymH8pS6mfWpdope%2F%2BB6JoYvKKPN%2FQMpvROl0BxNdTD%2FgNUNqKjlNfUDtV7NqaDJlTqtlTXp44%2F7AUk7yJgK9UlVmp7B30oNH3fPtNXEFBbowoVczqcDBfp%2BxDBMZRFDa37VNcoIdjEBpBTCZk5hONDpjlp%2FyGd1EPSswbQyr6nA5xwLunfF6HhWA%2B8ZMp5raiepAPm%2FS7QfpbiZGtEZ%2FoVWENmPI4HLjDKYjXRJ7i680K9cMDeFSHjHvaTYsgOh09jmL5OnKSMRbANl4bNihk%2FX7pWgxVmbV0Qj%2BQ5eDpvsYUe9i%2FTUVAyODDU5KevBjqeATdV%2Fp9WiSN1mc1%2FUxn60TYZRFAjcTm6lfdbdtEEWneexsLLj6BpoW6gUA1c73JjEXsOEGbaSfHXi%2BI6nFtlNJpKlP%2BbrFlylA2qmIvlnKJzv2ALrsARUmCH1Kl26CVFfOtnJv7VZmDSVnS9nr4mYLHLkPjIhBaF3IxWVcFR7He0CCfRv%2BYkHzTlVdzoK%2BmJkUVyofY%2B3Bt3dDkpk7No\&X-Amz-Signature\=1d4cbc65a8440c89eb2770b2edfe4e3fe91831856ee03d0d939911d9963337f0\&X-Amz-SignedHeaders\=content-length%3Bhost%3Bx-amz-checksum-sha256\&x-id\=PutObject
```

<Callout type="info">
Please note that your storage space has been allocated at this point - if you fail to `PUT` the file you will still be charged for storage!
The good news is that you can store the same file as many times as you like without being charged for any additional space.
</Callout>

Your bits are now on IPFS, en route to the Filecoin Network, _but they will not show up as uploads in your web3.storage account!_ To
finish "uploading" your file to web3.storage you'll need to register your upload as described in the next section.

## Registering Uploads

To support arbitrarily large file uploads, our upload service requires large files to be sharded into multiple CARs, each
of which is uploaded seperately according to the instructions in the "Storing Files" section above.

Once the files have been uploaded, create a file (in this example we'll name it `upload.json`) with the following contents, replacing
`did:key:z6Mkabc123` with the DID of the space you used to generate auth headers above:

```json
{
  "tasks": [
    [
      "upload/add",
      "did:key:z6Mkabc123",
      {
        "root": {
          "/": "bafybeidhkumeonuwkebh2i4fc7o7lguehauradvlk57gzake6ggjsy372a"
        },
        "shards": [
          {
            "/": "bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq"
          }
        ]
      }
    ]
  ]
}
```

Change the `root` CID to the CID output when you ran `ipfs-car pack` above. Change the `shards` CID to the CID output
when you ran `ipfs-car hash` above.

Finally, run:

```sh
curl -X POST \
-H "X-Auth-Secret: uOGQyYzRhYWQwNmY3NtEwOTg1ZWU0NDU0NjByNTg2ZGE" \
-H "Authorization: uOqJlcm9vdHOB2CpYKQABcRIgYVymlT6sxiDd45CA0f..." \
-d @upload.json \
https://up.web3.storage/bridge
```

being sure to again replace `X-Auth-Secret` and `Authorization` with the values generated by `w3 bridge generate-tokens`.

If everything works as expected you will now see your upload when you invoke `upload/list` per the instructions in
"Listing Uploads" above!

## Batching Operations

The operations described in "Storing Files" and "Registering Uploads" above can be combined into a single HTTP
request to the bridge. To see this in action, create a file (in this example we'll name it `store-and-upload.json`)
with the following contents, replacing `did:key:z6Mkabc123` with the DID of the space you used to generate
auth headers above and the values of the `link`, `root` and `shards` keys with the CIDs of your upload:

```json
{
  "tasks": [
    [
      "store/add",
      "did:key:z6Mkabc123",
      {
        "link": { "/": "bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq" },
        "size": 161
      }
    ],
    [
      "upload/add",
      "did:key:z6Mkabc123",
      {
        "root": {
          "/": "bafybeidhkumeonuwkebh2i4fc7o7lguehauradvlk57gzake6ggjsy372a"
        },
        "shards": [
          {
            "/": "bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq"
          }
        ]
      }
    ]
  ]
}
```

And run:

```sh
curl -X POST \
-H "X-Auth-Secret: uOGQyYzRhYWQwNmY3NtEwOTg1ZWU0NDU0NjByNTg2ZGE" \
-H "Authorization: uOqJlcm9vdHOB2CpYKQABcRIgYVymlT6sxiDd45CA0f..." \
-d @store-and-upload.json \
https://up.web3.storage/bridge
```

being sure to again replace `X-Auth-Secret` and `Authorization` with the values generated by `w3 bridge generate-tokens`.

You'll get a result that looks like this:

```json
[
  {
    "p": {
      "fx": {
        "fork": []
      },
      "iss": "did:web:web3.storage",
      "meta": {},
      "out": {
        "ok": {
         "allocated": 161,
          "headers": {
            "content-length": "161",
            "x-amz-checksum-sha256": "5NswWHZdy73RY/nH3BQAGKfTAXKPO1BYLmJCjEx34PM="
          },
          "link": {
            "/": "bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq"
          },
          "status": "upload",
          "url": "https://carpark-prod-0.s3.us-west-2.amazonaws.com/bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq/bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq.car?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAXLN6VFMM76NYBTG7%2F20240307%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240307T170854Z&X-Amz-Expires=86400&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEMn%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQC2snXc59uBD2ugjc7C9DiKP0447T7fZ0A010Ph6iDswgIgfq0fYWE4Y9FByHz%2B6mYRussCgVr9KlBV1eGd1kgA22Yq3AMIwv%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw1MDU1OTUzNzQzNjEiDCjNsn%2FQBypcXnybPCqwAyGtjDvgxmoQg8IYvO4vQ5fxZw%2F69mzSB%2BJmJMl9gnMaQ7SqUuTQnamPEZHM%2BaztPTbSBFm26S9o4GcZWn5S9UCOLb4YV6sAeCC3XCMkc58RPvyehMiVf0xdN1lBCLkFDd%2BHDb0cPEOvvJbTor22rhCo9L%2FsAVZPAYBu1efwvifCMnUebFeA3Qc0lvYG9PqLtZwo2ZMeVCwXYZiwec%2FpwdobopEWve88GJtxrVyiWMuV4pO7A68cty5ukFr0aRwNHM9g2e2y%2BSymH8pS6mfWpdope%2F%2BB6JoYvKKPN%2FQMpvROl0BxNdTD%2FgNUNqKjlNfUDtV7NqaDJlTqtlTXp44%2F7AUk7yJgK9UlVmp7B30oNH3fPtNXEFBbowoVczqcDBfp%2BxDBMZRFDa37VNcoIdjEBpBTCZk5hONDpjlp%2FyGd1EPSswbQyr6nA5xwLunfF6HhWA%2B8ZMp5raiepAPm%2FS7QfpbiZGtEZ%2FoVWENmPI4HLjDKYjXRJ7i680K9cMDeFSHjHvaTYsgOh09jmL5OnKSMRbANl4bNihk%2FX7pWgxVmbV0Qj%2BQ5eDpvsYUe9i%2FTUVAyODDU5KevBjqeATdV%2Fp9WiSN1mc1%2FUxn60TYZRFAjcTm6lfdbdtEEWneexsLLj6BpoW6gUA1c73JjEXsOEGbaSfHXi%2BI6nFtlNJpKlP%2BbrFlylA2qmIvlnKJzv2ALrsARUmCH1Kl26CVFfOtnJv7VZmDSVnS9nr4mYLHLkPjIhBaF3IxWVcFR7He0CCfRv%2BYkHzTlVdzoK%2BmJkUVyofY%2B3Bt3dDkpk7No&X-Amz-Signature=1d4cbc65a8440c89eb2770b2edfe4e3fe91831856ee03d0d939911d9963337f0&X-Amz-SignedHeaders=content-length%3Bhost%3Bx-amz-checksum-sha256&x-id=PutObject",
          "with": "did:key:z6Mkabc123"
        }
      },
      "prf": [],
      "ran": {
        "/": "bafyreiclycv7vdfutbtakytkbvcpx2ontlp3fusfb7niugvy5a6kawnhk4"
      }
    },
    "s": {
      "/": {
        "bytes": "7aEDQDosaCizSSLXXm55dAeuDACNw2H9/JoUa6oLkLY7mv6TXeW+Z0xJouYj1MGf6LpHn756IW2NprqXq4c20EjlOwM"
      }
    }
  },
  {
    "p": {
      "fx": {
        "fork": []
      },
      "iss": "did:web:web3.storage",
      "meta": {},
      "out": {
        "ok": {
          "root": {
            "/": "bafybeidhkumeonuwkebh2i4fc7o7lguehauradvlk57gzake6ggjsy372a"
          },
          "shards": [
            {
              "/": "bagbaiera4tntawdwlxf33uld7hd5yfaadct5galsr45vawbomjbiytdx4dzq"
            },
            {
              "/": "bagbaieraw4kz73gtuttgxlckdby7fezy4o5hdfspcrl7nqxsh3ultzse2q2a"
            }
          ]
        }
      },
      "prf": [],
      "ran": {
        "/": "bafyreihobt6uxochgcmfs5bhetynrccrqsuipwp5cy5xxclvqgzw7qsmui"
      }
    },
    "s": {
      "/": {
        "bytes": "7aEDQIa1JFOzEWHHfUZQJqRhZzElISfhq4b9Xqca0TgjX+3N7SLrYTB6SN/2GdLSgkRuIKZivB+tSdG4s/+Fvh1CxAQ"
      }
    }
  }
]
```

Remember that if the `status` field of the `store/add` result is `upload` you will then need to `PUT` your file to the
to the given URL with the given headers.

## Sharded Uploads

If you'd like to store a file larger than 5GB you'll need to shard it into smaller CARs before storing. We don't
proscribe any particular sharding algorithm - you'll need to:

1. read the input CAR
2. write the first CAR file header
3. write blocks until the first CAR hits your limit (a number lower than 5GB)
4. write a new CAR file header for the second CAR
5. write blocks until the second CAR hits your limit
6. repeat until end of blocks

If you're implementing this yourself it may be helpful to look
into [our JavaScript implementation](https://github.com/web3-storage/w3up/blob/d6978d7ab299be76987c6533d18e6857f6998fe6/packages/upload-client/src/index.js#L38).
We provide an example here using the [`carbites-cli`](https://www.npmjs.com/package/carbites-cli) utility:

First we'll create an absolutely gigantic file:

```sh
echo "this is an absolutely gigantic file created by travis" > big.txt
ipfs-car pack big.txt > big.car
bafybeicq2urqdqum3ykblswqzzxf6wpy3mcbr6jg52ai2zlhds4l7ho5wa
```

We'll save the CID `ipfs-car` outputs so we can use it in our `store/add` invocation later.

Next we'll use `carbites` to split this file. We are using the `50B` option to split into 50 byte
chunks - you'll probably want to use something much larger like `100MB`:

```sh
carbites split big.car --size 50B
```

You should now see three files, `big-0.car`, `big-1.car` and `big-2.car`. Calculate the CID and size of each one:

```sh
wc big-*
       1      12     109 big-0.car
       2       7     118 big-1.car
       0       1      26 big-2.car
       3      20     253 total
ipfs-car hash big-0.car
bagbaiera5pcs7vgks34rflh47c6cprzoift7vfch6gmbm3odq7auw2iou3cq
ipfs-car hash big-1.car
bagbaierau2ocmnrl5ilikq5xtxckz3owbe5xallbx24fkvislzu7k7ydqzia
ipfs-car hash big-2.car
bagbaierawa335d45pwohko5s4fbut7nlfjavq2kan7z3gbzvm2k3zutifv5q
```

Next, create a file (in this example we'll name it `store-and-upload.json`) and put the following JSON
in it. The `link` and `size` in each `store/add` should match the CID and size calculated above, and
each `link` should also appear in the `shards` array of the `upload/add` call. The `root` CID in the `upload/add`
should be the CID output by `ipfs-car pack` above. Be sure to update the space DID `did:key:z6Mkabc123` to match
the space you used when you generated auth tokens!

```json
{
  "tasks": [
    [
      "store/add",
      "did:key:z6Mkabc123",
      {
        "link": {
          "/": "bagbaiera5pcs7vgks34rflh47c6cprzoift7vfch6gmbm3odq7auw2iou3cq"
        },
        "size": 109
      }
    ],
    [
      "store/add",
      "did:key:z6Mkabc123",
      {
        "link": {
          "/": "bagbaierau2ocmnrl5ilikq5xtxckz3owbe5xallbx24fkvislzu7k7ydqzia"
        },
        "size": 118
      }
    ],
    [
      "store/add",
      "did:key:z6Mkabc123",
      {
        "link": {
          "/": "bagbaierawa335d45pwohko5s4fbut7nlfjavq2kan7z3gbzvm2k3zutifv5q"
        },
        "size": 26
      }
    ],
    [
      "upload/add",
      "did:key:z6Mkabc123",
      {
        "root": {
          "/": "bafybeicq2urqdqum3ykblswqzzxf6wpy3mcbr6jg52ai2zlhds4l7ho5wa"
        },
        "shards": [
          {
            "/": "bagbaiera5pcs7vgks34rflh47c6cprzoift7vfch6gmbm3odq7auw2iou3cq"
          },
          {
            "/": "bagbaierau2ocmnrl5ilikq5xtxckz3owbe5xallbx24fkvislzu7k7ydqzia"
          },
          {
            "/": "bagbaierawa335d45pwohko5s4fbut7nlfjavq2kan7z3gbzvm2k3zutifv5q"
          }                    
        ]
      }
    ]
  ]
}
```

Once you receive a response, you'll need to `PUT` each of the cars to their respective upload URLs. Given this result:

```json
[
  {
    "p": {
      "fx": {
        "fork": []
      },
      "iss": "did:web:web3.storage",
      "meta": {},
      "out": {
        "ok": {
          "allocated": 0,
          "link": {
            "/": "bagbaiera5pcs7vgks34rflh47c6cprzoift7vfch6gmbm3odq7auw2iou3cq"
          },
          "status": "done",
          "with": "did:key:z6Mkabc123"
        }
      },
      "prf": [],
      "ran": {
        "/": "bafyreia526axkta24us4fxjghfqbwu2d7lk2neucrseoapakkcmgoy6x7u"
      }
    },
    "s": {
      "/": {
        "bytes": "7aEDQN9dWcLsWIwCMOLmzXP971VkJTU1hXliFpEpZZAYQhmOzReViM4TE4tp1AS4vwLcXzawiwaWJ+bkzvh2DKdx4go"
      }
    }
  },
  {
    "p": {
      "fx": {
        "fork": []
      },
      "iss": "did:web:web3.storage",
      "meta": {},
      "out": {
        "ok": {
          "allocated": 0,
          "link": {
            "/": "bagbaierau2ocmnrl5ilikq5xtxckz3owbe5xallbx24fkvislzu7k7ydqzia"
          },
          "status": "done",
          "with": "did:key:z6Mkabc123"
        }
      },
      "prf": [],
      "ran": {
        "/": "bafyreidi655w32on25adjxnoxro3dnqcsncqly62uc6jyz6l25r45bd5lu"
      }
    },
    "s": {
      "/": {
        "bytes": "7aEDQALj9TzBJdqsXs8RY5NoIwy63wvALLw/U1gRcOkBp8VBoIqwEuL3xjjvr0RCnXzLoPQGszTP/xp/A51BJ0mlYQs"
      }
    }
  },
  {
    "p": {
      "fx": {
        "fork": []
      },
      "iss": "did:web:web3.storage",
      "meta": {},
      "out": {
        "ok": {
          "allocated": 0,
          "link": {
            "/": "bagbaierawa335d45pwohko5s4fbut7nlfjavq2kan7z3gbzvm2k3zutifv5q"
          },
          "status": "done",
          "with": "did:key:z6Mkabc123"
        }
      },
      "prf": [],
      "ran": {
        "/": "bafyreic5wcfzvafpkt2haz77ya7zq5ka5ort73i4ahq2mvenj7zssyy6eq"
      }
    },
    "s": {
      "/": {
        "bytes": "7aEDQCdO8OKGjxTpEgsQaJV0ZEoFBfXw6mZGWx+gMUPxHMFmiO8AVrzyNXXGP1dy0q16yI+6bnnLpuMC684/n5dZQAU"
      }
    }
  },
  {
    "p": {
      "fx": {
        "fork": []
      },
      "iss": "did:web:web3.storage",
      "meta": {},
      "out": {
        "ok": {
          "root": {
            "/": "bafybeicq2urqdqum3ykblswqzzxf6wpy3mcbr6jg52ai2zlhds4l7ho5wa"
          },
          "shards": [
            {
              "/": "bagbaiera5pcs7vgks34rflh47c6cprzoift7vfch6gmbm3odq7auw2iou3cq"
            },
            {
              "/": "bagbaierau2ocmnrl5ilikq5xtxckz3owbe5xallbx24fkvislzu7k7ydqzia"
            },
            {
              "/": "bagbaierawa335d45pwohko5s4fbut7nlfjavq2kan7z3gbzvm2k3zutifv5q"
            }
          ]
        }
      },
      "prf": [],
      "ran": {
        "/": "bafyreicirpydnj66okf2bqmuv4qbdgxggxqmj5ybr3pyngcp3iqdwckc6e"
      }
    },
    "s": {
      "/": {
        "bytes": "7aEDQHJEvkeOSIkKQ0SaMbEgNXjLOuwNPWg047O08pCgRSSQMKrM3B++k6Qs49m/xSxpswY1FxuA/dQuh1NWrhqTdAY"
      }
    }
  }
]
```

You'll need to run the following `curl` commands:

```sh
curl -X PUT \
-H "content-length: 109" \
-H "x-amz-checksum-sha256: 68Uv1MqW+RKs/Pi8J8cuQWf6lEfxmBZtw4fBS2kOpsU=" \
-H "content-type: application/vnd.ipld.car" \
--data-binary @big-0.car \
https://carpark-prod-0.s3.us-west-2.amazonaws.com/bagbaiera5pcs7vgks34rflh47c6cprzoift7vfch6gmbm3odq7auw2iou3cq/bagbaiera5pcs7vgks34rflh47c6cprzoift7vfch6gmbm3odq7auw2iou3cq.car?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAXLN6VFMMXACSF74D%2F20240311%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240311T185406Z&X-Amz-Expires=86400&X-Amz-Security-Token=IQoJb3JpZ2luX2VjECsaCXVzLXdlc3QtMiJIMEYCIQCKTNRl%2FrZ47BKRxhGtQfkvjcvPMxBJMWUENt7EL4VYTgIhAO14%2Fs%2Bc3sh2TevvAxplSRT75wFFD9D88Fi3UXDKKCx3KtMDCDQQABoMNTA1NTk1Mzc0MzYxIgz9y4RR%2FZSZB4cqKpcqsAOKYIdtPJflZPodH36ke9NbJNTtfbD7E2LujMS7XEyU2sZnwQyTEzsVL%2FJvB3s8Z3eeKhN4xKnkbUAf%2BryO1ig1plAwzjnIpQzauv89AalyJTS7UM%2FymvWnLo2Qx%2Br92owtQCzOZmrREMVqAU0rCZrMv6NWcOH0bkaM%2FmuA6MijF2dfH3mGeW5E0lFqXaJL5OJqclREtJwRomotSljBVoYxoz2PHRvgIKFuezC1reS3XJ3EnWRlbohQzhfGov%2BtOtcUhJIVk8wqXQvyEFOjErapALiIq4oeUBoIpeKXR5iHJDgndnxGvPOG9ihjUMzKwcbEwqQZTSkTK2whRoHcSZgedzWpsQgae3vQjr797H%2Flh7XLSGzHAuy0Bb9zB61ZZRUyKbhODFCw%2BOpk9ihPKedaewtRHe4SYvAYwBcM0%2FZC%2BwcAOOK987eUxnULeHei%2Fs%2BigKBnzGWwojcuqSzdvaRX3yaK9yKG8mT6aMsAYKS%2BjG%2FX%2FlAu3UL4pe7KK2fxHEH1KrQgdaTCsdzaB%2FApfsixRH4XeGOTNk9ZYM2rI70aqMd%2F5fveFO2%2F33EKZSrQg9kw65i9rwY6nQFkK7gFDZd2oCG7e3u3lqDe5%2BQAqBshYAKbOzpMM6VQq0AqLFeO3TWv%2FhlSP8z9Xxadf3IFRciPlQbMV85VXxEDCzyTYAkLQJsqVuyI%2FQF9hW1rk1UcvOTVpcDRXuwBm%2B66Cq48OnTGzdMu32f%2FsKe7aacdi4msVqU2Z4JwvyjewD4biHJ7lNUkAUf16Zz7SKkLvSvxO%2FwqV7HcxrEs&X-Amz-Signature=5ce3660c1fc5364457e8f3732b759b9c17b3336011e0a04c119cb44bc56913ed&X-Amz-SignedHeaders=content-length%3Bhost%3Bx-amz-checksum-sha256&x-id=PutObject

curl -X PUT \
-H "content-length: 118" \
-H "x-amz-checksum-sha256: ppwmNivqFoVDt53ErO3WCTtwLWG+uFVVEl5p9X8DhlA=" \
-H "content-type: application/vnd.ipld.car" \
--data-binary @big-1.car \
https://carpark-prod-0.s3.us-west-2.amazonaws.com/bagbaierau2ocmnrl5ilikq5xtxckz3owbe5xallbx24fkvislzu7k7ydqzia/bagbaierau2ocmnrl5ilikq5xtxckz3owbe5xallbx24fkvislzu7k7ydqzia.car?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAXLN6VFMMXACSF74D%2F20240311%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240311T185406Z&X-Amz-Expires=86400&X-Amz-Security-Token=IQoJb3JpZ2luX2VjECsaCXVzLXdlc3QtMiJIMEYCIQCKTNRl%2FrZ47BKRxhGtQfkvjcvPMxBJMWUENt7EL4VYTgIhAO14%2Fs%2Bc3sh2TevvAxplSRT75wFFD9D88Fi3UXDKKCx3KtMDCDQQABoMNTA1NTk1Mzc0MzYxIgz9y4RR%2FZSZB4cqKpcqsAOKYIdtPJflZPodH36ke9NbJNTtfbD7E2LujMS7XEyU2sZnwQyTEzsVL%2FJvB3s8Z3eeKhN4xKnkbUAf%2BryO1ig1plAwzjnIpQzauv89AalyJTS7UM%2FymvWnLo2Qx%2Br92owtQCzOZmrREMVqAU0rCZrMv6NWcOH0bkaM%2FmuA6MijF2dfH3mGeW5E0lFqXaJL5OJqclREtJwRomotSljBVoYxoz2PHRvgIKFuezC1reS3XJ3EnWRlbohQzhfGov%2BtOtcUhJIVk8wqXQvyEFOjErapALiIq4oeUBoIpeKXR5iHJDgndnxGvPOG9ihjUMzKwcbEwqQZTSkTK2whRoHcSZgedzWpsQgae3vQjr797H%2Flh7XLSGzHAuy0Bb9zB61ZZRUyKbhODFCw%2BOpk9ihPKedaewtRHe4SYvAYwBcM0%2FZC%2BwcAOOK987eUxnULeHei%2Fs%2BigKBnzGWwojcuqSzdvaRX3yaK9yKG8mT6aMsAYKS%2BjG%2FX%2FlAu3UL4pe7KK2fxHEH1KrQgdaTCsdzaB%2FApfsixRH4XeGOTNk9ZYM2rI70aqMd%2F5fveFO2%2F33EKZSrQg9kw65i9rwY6nQFkK7gFDZd2oCG7e3u3lqDe5%2BQAqBshYAKbOzpMM6VQq0AqLFeO3TWv%2FhlSP8z9Xxadf3IFRciPlQbMV85VXxEDCzyTYAkLQJsqVuyI%2FQF9hW1rk1UcvOTVpcDRXuwBm%2B66Cq48OnTGzdMu32f%2FsKe7aacdi4msVqU2Z4JwvyjewD4biHJ7lNUkAUf16Zz7SKkLvSvxO%2FwqV7HcxrEs&X-Amz-Signature=dc200cb342555a9a40fe50c45fc7433a7f9e6eaadb233a5f2ddd5f5bacf3ef2b&X-Amz-SignedHeaders=content-length%3Bhost%3Bx-amz-checksum-sha256&x-id=PutObject

curl -X PUT \
-H "content-length: 26" \
-H "x-amz-checksum-sha256: sDe+j519nHU7suFDSf2rKkFYaUBv87MHNWaVvNJoLXs=" \
-H "content-type: application/vnd.ipld.car" \
--data-binary @big-2.car \
https://carpark-prod-0.s3.us-west-2.amazonaws.com/bagbaierawa335d45pwohko5s4fbut7nlfjavq2kan7z3gbzvm2k3zutifv5q/bagbaierawa335d45pwohko5s4fbut7nlfjavq2kan7z3gbzvm2k3zutifv5q.car?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAXLN6VFMMXACSF74D%2F20240311%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20240311T185406Z&X-Amz-Expires=86400&X-Amz-Security-Token=IQoJb3JpZ2luX2VjECsaCXVzLXdlc3QtMiJIMEYCIQCKTNRl%2FrZ47BKRxhGtQfkvjcvPMxBJMWUENt7EL4VYTgIhAO14%2Fs%2Bc3sh2TevvAxplSRT75wFFD9D88Fi3UXDKKCx3KtMDCDQQABoMNTA1NTk1Mzc0MzYxIgz9y4RR%2FZSZB4cqKpcqsAOKYIdtPJflZPodH36ke9NbJNTtfbD7E2LujMS7XEyU2sZnwQyTEzsVL%2FJvB3s8Z3eeKhN4xKnkbUAf%2BryO1ig1plAwzjnIpQzauv89AalyJTS7UM%2FymvWnLo2Qx%2Br92owtQCzOZmrREMVqAU0rCZrMv6NWcOH0bkaM%2FmuA6MijF2dfH3mGeW5E0lFqXaJL5OJqclREtJwRomotSljBVoYxoz2PHRvgIKFuezC1reS3XJ3EnWRlbohQzhfGov%2BtOtcUhJIVk8wqXQvyEFOjErapALiIq4oeUBoIpeKXR5iHJDgndnxGvPOG9ihjUMzKwcbEwqQZTSkTK2whRoHcSZgedzWpsQgae3vQjr797H%2Flh7XLSGzHAuy0Bb9zB61ZZRUyKbhODFCw%2BOpk9ihPKedaewtRHe4SYvAYwBcM0%2FZC%2BwcAOOK987eUxnULeHei%2Fs%2BigKBnzGWwojcuqSzdvaRX3yaK9yKG8mT6aMsAYKS%2BjG%2FX%2FlAu3UL4pe7KK2fxHEH1KrQgdaTCsdzaB%2FApfsixRH4XeGOTNk9ZYM2rI70aqMd%2F5fveFO2%2F33EKZSrQg9kw65i9rwY6nQFkK7gFDZd2oCG7e3u3lqDe5%2BQAqBshYAKbOzpMM6VQq0AqLFeO3TWv%2FhlSP8z9Xxadf3IFRciPlQbMV85VXxEDCzyTYAkLQJsqVuyI%2FQF9hW1rk1UcvOTVpcDRXuwBm%2B66Cq48OnTGzdMu32f%2FsKe7aacdi4msVqU2Z4JwvyjewD4biHJ7lNUkAUf16Zz7SKkLvSvxO%2FwqV7HcxrEs&X-Amz-Signature=232f28f1b4392e185aadc27c50e96ba6101529f7a9cbca8eced582602a9a0e81&X-Amz-SignedHeaders=content-length%3Bhost%3Bx-amz-checksum-sha256&x-id=PutObject
```

Once this is all done you'll be able to see your upload in `w3 ls` and through the gateway, eg at https://bafybeicq2urqdqum3ykblswqzzxf6wpy3mcbr6jg52ai2zlhds4l7ho5wa.ipfs.w3s.link
